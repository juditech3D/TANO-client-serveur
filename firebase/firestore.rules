rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function role() { return request.auth.token.role; }
    function isAdmin() { return role() == "ADMIN"; }
    function isMechanic() { return role() == "MECHANIC"; }
    function isStaff() { return isAdmin() || isMechanic(); }
    function customerId() { return request.auth.token.customerId; }

    match /users/{uid} {
      allow read: if isStaff() || (isSignedIn() && request.auth.uid == uid);
      allow write: if isAdmin() || request.auth.uid == uid;
    }

    match /customers/{cid} {
      allow read: if isStaff() || (isSignedIn() && resource.data.userId == request.auth.uid);
      allow write: if isStaff();
    }

    match /vehicles/{vid} {
      allow read: if isStaff() || (isSignedIn() && resource.data.customerId == customerId());
      allow create, update, delete: if isStaff();
    }

    match /workOrders/{woId} {
      allow read: if isStaff()
        || (isSignedIn() &&
            get(/databases/$(database)/documents/vehicles/$(resource.data.vehicleId)).data.customerId == customerId());
      allow create, update, delete: if isStaff();

      match /items/{itemId} {
        allow read: if isStaff()
          || (isSignedIn() &&
              get(/databases/$(database)/documents/vehicles/
                $(get(/databases/$(database)/documents/workOrders/$(woId)).data.vehicleId)).data.customerId == customerId());
        allow create, update, delete: if isStaff();
      }
    }

    match /nfcTags/{tagId} {
      allow read: if isStaff();
      allow write: if isStaff();
    }

    match /appointments/{apptId} {
      allow read: if isStaff() || (isSignedIn() && resource.data.customerId == customerId());
      allow create, update, delete: if isStaff();
    }
  }
}
